<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>用户下单</title>
  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; background: #f9f9f9; }
    .container { padding: 16px; }
    h2 { margin-bottom: 16px; }
    .product { background: #fff; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); margin-bottom: 16px; padding: 12px; }
    .product img { width: 100%; border-radius: 4px; }
    .product h3 { margin: 8px 0; }
    .specs, .quantity { margin: 8px 0; }
    .specs select, .quantity input { padding: 6px; font-size: 14px; }
    .price { font-size: 16px; color: #e53935; margin-top: 8px; }
    .btn-cart { margin-top: 8px; background: #1e88e5; color: #fff; border: none; padding: 10px; width: 100%; border-radius: 4px; cursor: pointer; }
    .cart { background: #fff; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); padding: 12px; margin-top: 24px; }
    .cart h3 { margin-bottom: 8px; }
    .cart ul { list-style: none; padding: 0; }
    .cart-total { text-align: right; margin-top: 8px; font-size: 16px; font-weight: bold; }
    .btn-order { margin-top: 12px; background: #43a047; color: #fff; border: none; padding: 12px; width: 100%; border-radius: 4px; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <h2>点餐中心</h2>
    <div id="productList"></div>

    <div class="cart" id="cartSummary">
      <h3>购物车</h3>
      <ul id="cartList"></ul>
      <div class="cart-total">总计：<span id="cartTotal">¥0</span></div>
      <button class="btn-order" onclick="submitOrder()">提交订单</button>
    </div>
  </div>

  <script>
    window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.ready();

    let cart = {};

    // 示例：如果你已经做了 Apps Script 就可以直接请求，如果没做，就用静态演示
    const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbyHi8NIV9in1xqC_sl4Cdwhrtnp1ywaAMQE5Zzb2e-EUiiGA8zQa-bgT7LLeF9ea5Cg/exec";

    // 1. 加载商品列表（动态 Fetch 或者用静态示例）
    fetch(SHEET_API_URL)
      .then(resp => resp.json())
      .then(products => {
        renderProducts(products);
      })
      .catch(err => {
        console.error("拉取商品失败：", err);
        document.getElementById("productList").innerHTML = "<p style='color:red;'>加载商品失败，请稍后重试。</p>";
      });

    function renderProducts(products) {
      const pl = document.getElementById("productList");
      pl.innerHTML = "";
      products.forEach(item => {
        const pid = item.id;
        const name = item["名称"];
        const imgUrl = item["图片_URL"];
        const priceSmall = item["小杯价格"];
        const priceMedium = item["中杯价格"];
        const priceLarge = item["大杯价格"];
        const tag = item["标签(tag)"] || "";

        let badgeHTML = "";
        if (tag.toLowerCase() === "hot") {
          badgeHTML = '<div style="position:absolute; top:8px; right:8px; background:#e53935; color:#fff; padding:4px 8px; border-radius:4px;">Hot</div>';
        } else if (tag.toLowerCase() === "new") {
          badgeHTML = '<div style="position:absolute; top:8px; right:8px; background:#43a047; color:#fff; padding:4px 8px; border-radius:4px;">New</div>';
        }

        const card = document.createElement("div");
        card.className = "product";
        card.innerHTML = `
          <div style="position: relative;">
            <img src="${imgUrl}" alt="${name}" />
            ${badgeHTML}
          </div>
          <h3>${name}</h3>
          <div class="specs">
            <label>规格：
              <select id="size_${pid}">
                <option value="small" data-price="${priceSmall}">小杯 ¥${priceSmall}</option>
                <option value="medium" data-price="${priceMedium}">中杯 ¥${priceMedium}</option>
                <option value="large" data-price="${priceLarge}">大杯 ¥${priceLarge}</option>
              </select>
            </label>
          </div>
          <div class="quantity">
            <label>数量：
              <input type="number" id="qty_${pid}" value="1" min="1" />
            </label>
          </div>
          <div class="price" id="price_${pid}">¥${priceSmall}</div>
          <button class="btn-cart" onclick="addToCart('${pid}', '${name}')">加入购物车</button>
        `;
        pl.appendChild(card);

        // 监听规格下拉，更新价格展示
        document.getElementById(`size_${pid}`).addEventListener("change", () => {
          const sel = document.getElementById(`size_${pid}`);
          const unit = parseInt(sel.options[sel.selectedIndex].dataset.price, 10);
          document.getElementById(`price_${pid}`).innerText = `¥${unit}`;
        });
      });
    }

    function addToCart(pid, name) {
      const sel = document.getElementById(`size_${pid}`);
      const size = sel.value;
      const unitPrice = parseInt(sel.options[sel.selectedIndex].dataset.price, 10);
      const qty = parseInt(document.getElementById(`qty_${pid}`).value, 10) || 1;
      const subtotal = unitPrice * qty;
      cart[pid] = { name, size, price: unitPrice, qty, subtotal };
      renderCart();
    }

    function renderCart() {
      const cartList = document.getElementById("cartList");
      const cartTotalEl = document.getElementById("cartTotal");
      cartList.innerHTML = "";
      let total = 0;
      Object.keys(cart).forEach(pid => {
        const it = cart[pid];
        total += it.subtotal;
        const li = document.createElement("li");
        li.innerText = `${it.name}（${it.size}） x ${it.qty} → ¥${it.subtotal}`;
        cartList.appendChild(li);
      });
      cartTotalEl.innerText = `¥${total}`;
    }

    function submitOrder() {
      if (Object.keys(cart).length === 0) {
        alert("购物车为空，请先添加商品");
        return;
      }

      const tg = window.Telegram && window.Telegram.WebApp;
      const tgUser = tg ? tg.initDataUnsafe.user : null;

      const orderData = {
        action: "create_order",
        order: {
          items: Object.keys(cart).map(pid => cart[pid]),
          total: Object.values(cart).reduce((sum, it) => sum + it.subtotal, 0),
          timestamp: new Date().toISOString()
        },
        user: tgUser
      };

      if (tg && typeof tg.sendData === "function") {
        tg.sendData(JSON.stringify(orderData));
      } else {
        console.log("模拟发送订单：", orderData);
        alert("请在 Telegram WebApp 模式下打开此页面，才能真正发给 Bot。");
      }
    }
  </script>
</body>
</html>

<script>
// === override: 支持 spec1/price1, spec2/price2, spec3/price3 ===
function normalizeMenuRow(r){
  const pick=(...ks)=>{for(const k of ks){if(r[k]!==undefined&&r[k]!==null&&String(r[k]).trim()!=='')return r[k];}return''};
  const price=(v)=>{ if(v==null) return 0;
    if(typeof v==='number') return isFinite(v)?v:0;
    const s=String(v).trim(); if(!s || /no\s*price/i.test(s)) return 0;
    const m=s.match(/[-+]?[0-9]*\.?[0-9]+/); return m?parseFloat(m[0]):0;
  };

  const name   = String(pick('name','title','product','item')||'').trim();
  const badge  = String(pick('badge','tag','new','promo_badge')||'').trim();
  const type   = String(pick('type','category','cat')||'').trim().toUpperCase();
  const desc   = String(pick('desc','description','details')||'').trim();
  const img    = String(pick('img','image','photo','img_url','image_url')||'').trim();
  const thccbd = String(pick('thccbd','THC/CBD','THC','CBD')||'').trim();
  const shop   = String(pick('shop','shop_id','store')||'').trim();

  // 兼容旧字段（priceQ/H/OZ）
  const legacyQ  = price(pick('priceQ','price_q','q_price','Q','q','Q_price','price-q'));
  const legacyH  = price(pick('priceH','price_h','h_price','H','h','H_price','price-h'));
  const legacyOZ = price(pick('priceOZ','price_oz','oz_price','OZ','oz','Oz','O','O_price','price-oz'));

  // 新：从 spec1/2/3 + price1/2/3 读取
  const s1 = String(pick('spec1','spec_1','option1','opt1')||'').trim();
  const s2 = String(pick('spec2','spec_2','option2','opt2')||'').trim();
  const s3 = String(pick('spec3','spec_3','option3','opt3')||'').trim();
  const p1 = price(pick('price1','price_1','p1'));
  const p2 = price(pick('price2','price_2','p2'));
  const p3 = price(pick('price3','price_3','p3'));

  const specs = [];
  const push = (label, p)=>{ if(label && p>0) specs.push({label:String(label).trim(), price:p}); };
  push(s1,p1); push(s2,p2); push(s3,p3);

  // 没写 specX 时，用旧 Q/H/OZ 做兜底
  if (!specs.length){
    if (legacyQ>0)  specs.push({label:'Q',  price:legacyQ});
    if (legacyH>0)  specs.push({label:'H',  price:legacyH});
    if (legacyOZ>0) specs.push({label:'OZ', price:legacyOZ});
  }

  // 为兼容旧渲染，尝试从 specs 回填 Q/H/OZ
  const tag = l=>{ const x=String(l||'').toLowerCase();
    if(x==='q'||x.includes('quarter')) return 'Q';
    if(x==='h'||x.includes('half'))    return 'H';
    if(x==='oz'||x.includes('ounce'))  return 'OZ';
    return '';
  };
  let priceQ=legacyQ, priceH=legacyH, priceOZ=legacyOZ;
  for(const sp of specs){
    const t = tag(sp.label);
    if(t==='Q' && !priceQ)  priceQ  = sp.price;
    if(t==='H' && !priceH)  priceH  = sp.price;
    if(t==='OZ'&& !priceOZ) priceOZ = sp.price;
  }

  return { name,
           title: pick('title_sub','subtitle','sub','title')||'',
           badge, type, desc, img, thccbd, shop,
           priceQ, priceH, priceOZ, specs };
}

// 统一按钮渲染（优先用 specs）
function __renderButtons(obj, dispNameTitle){
  if (obj.specs && obj.specs.length){
    return obj.specs.map(s =>
      `<button class="menu-spec"
        onclick="addToCart('${obj.name.replace(/'/g,"\\'")}', '${String(s.label).replace(/'/g,"\\'")}', ${s.price}, '${(obj.img||'').replace(/'/g,"\\'")}', '${dispNameTitle.replace(/'/g,"\\'")}')">
        ${String(s.label)} ${money(s.price)}
      </button>`).join('');
  }
  // 兜底：旧的 Q/H/OZ
  const arr = [];
  if (obj.priceQ>0)  arr.push(`<button class="menu-spec" onclick="addToCart('${obj.name.replace(/'/g,"\\'")}', 'Q', ${obj.priceQ}, '${(obj.img||'').replace(/'/g,"\\'")}', '${dispNameTitle.replace(/'/g,"\\'")}')">Q ${money(obj.priceQ)}</button>`);
  if (obj.priceH>0)  arr.push(`<button class="menu-spec" onclick="addToCart('${obj.name.replace(/'/g,"\\'")}', 'H', ${obj.priceH}, '${(obj.img||'').replace(/'/g,"\\'")}', '${dispNameTitle.replace(/'/g,"\\'")}')">H ${money(obj.priceH)}</button>`);
  if (obj.priceOZ>0) arr.push(`<button class="menu-spec" onclick="addToCart('${obj.name.replace(/'/g,"\\'")}', 'OZ', ${obj.priceOZ}, '${(obj.img||'').replace(/'/g,"\\'")}', '${dispNameTitle.replace(/'/g,"\\'")}')">OZ ${money(obj.priceOZ)}</button>`);
  return arr.join('');
}

// 覆盖渲染函数（使用 __renderButtons）
const __old_renderMenuChunked = typeof renderMenuChunked==='function' ? renderMenuChunked : null;
function renderMenuChunked(items){
  const menuEl = document.getElementById('menu');
  if(!items || !items.length){ menuEl.innerHTML = `<div style="text-align:center;color:#ccc;margin-top:40px;">No items</div>`; return; }
  menuEl.innerHTML='';
  const batch=24; let i=0;
  function next(){
    const frag=document.createDocumentFragment();
    for(let c=0;c<batch && i<items.length;c++,i++){
      const obj=items[i];
      const dispNameTitle = stripCodeMark(obj.name);
      const thccbd = obj.thccbd? String(obj.thccbd).replace(/\s+/g,'') : '';
      const btns = __renderButtons(obj, dispNameTitle);
      const div=document.createElement('div'); div.className='card menu-item';
      div.innerHTML = `${obj.img? `<img class="menu-img" src="${obj.img}" loading="lazy" onclick="showImgModal('${obj.img}')" alt="item"/>` : "" }
        <div class="menu-info">
          <div class="menu-name">${dispNameTitle||''}${obj.badge?`<span class="menu-badge">${obj.badge}</span>`:''}${obj.type?`<span class="menu-type">${obj.type}</span>`:''}</div>
          <div style="display:flex;align-items:center;gap:9px;margin-bottom:2px;flex-wrap:wrap;">${obj.title?`<span class="menu-title">${obj.title}</span>`:''}${thccbd?`<span class="menu-thccbd">THC/CBD: ${thccbd}</span>`:''}</div>
          ${obj.desc?`<div class="menu-desc">${obj.desc}</div>`:''}
          <div class="menu-bottom-prices">${btns || '<span style="color:#ccc">No price</span>'}</div>
        </div>`;
      frag.appendChild(div);
    }
    menuEl.appendChild(frag); if(i<items.length){ requestAnimationFrame(next); }
  }
  requestAnimationFrame(next);
}

const __old_renderMenuFromCache = typeof renderMenuFromCache==='function' ? renderMenuFromCache : null;
function renderMenuFromCache(items){
  const menuEl=document.getElementById('menu');
  const html=(items||[]).map(obj=>{
    const dispNameTitle = stripCodeMark(obj.name);
    const thccbd = obj.thccbd? String(obj.thccbd).replace(/\s+/g,'') : '';
    const btns = __renderButtons(obj, dispNameTitle);
    return `<div class="card menu-item">
      ${obj.img?`<img class="menu-img" src="${obj.img}" loading="lazy" onclick="showImgModal('${obj.img}')" alt="item"/>`:''}
      <div class="menu-info">
        <div class="menu-name">${dispNameTitle||''}${obj.badge?`<span class="menu-badge">${obj.badge}</span>`:''}${obj.type?`<span class="menu-type">${obj.type}</span>`:''}</div>
        <div style="display:flex;align-items:center;gap:9px;margin-bottom:2px;flex-wrap:wrap;">${obj.title?`<span class="menu-title">${obj.title}</span>`:''}${thccbd?`<span class="menu-thccbd">THC/CBD: ${thccbd}</span>`:''}</div>
        ${obj.desc?`<div class="menu-desc">${obj.desc}</div>`:''}
        <div class="menu-bottom-prices">${btns || '<span style="color:#ccc">No price</span>'}</div>
      </div>
    </div>`;
  }).join('');
  menuEl.innerHTML = html || `<div style="text-align:center;color:#ccc;margin-top:40px;">No items</div>`;
}
</script>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Menu WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: sans-serif; background: #f7f7f7; margin: 0; padding: 0; }
    .container { padding: 16px; display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; }
    .card { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 12px; display: flex; flex-direction: column; }
    .card img { width: 100%; border-radius: 8px; object-fit: cover; margin-bottom: 8px; }
    .name { font-weight: bold; font-size: 1.1em; margin-bottom: 4px; }
    .price { margin: 4px 0; font-size: 1em; }
    .desc { font-size: 0.9em; color: gray; margin-bottom: 8px; }
    .selector { margin-bottom: 8px; }
    .button { background: #2cab37; color: white; padding: 8px; border-radius: 8px; border: none; cursor: pointer; }
    .button:active { background: #22962f; }
  </style>
</head>
<body>
  <div class="container" id="menu"></div>
  <script>
    const tg = window.Telegram.WebApp;
    const sheetID = "1hUlRnvEy-k2Arz8SVKpRsAaBEFTyS6RDJBDfwDmM-Hs";  // ä½ çš„ Google Sheet ID
    const sheetURL = `https://opensheet.elk.sh/${sheetID}/menu`;
    let cart = [];

    async function loadMenu() {
      const res = await fetch(sheetURL);
      const items = await res.json();
      // åˆ†ç»„ï¼šæŒ‰å•†å“åèšåˆè§„æ ¼
      const groups = {};
      items.filter(i => i["æ˜¯å¦ä¸Šæž¶"] === "TRUE").forEach(item => {
        const name = item["å•†å“å"];
        if (!groups[name]) groups[name] = [];
        groups[name].push(item);
      });

      const container = document.getElementById("menu");
      Object.values(groups).forEach(specs => {
        // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªè§„æ ¼
        let selected = specs[0];
        const card = document.createElement("div");
        card.className = "card";

        // åˆ›å»ºå…ƒç´ 
        const img = document.createElement("img");
        img.src = selected["å›¾ç‰‡é“¾æŽ¥"];
        img.alt = selected["å•†å“å"];

        const nameEl = document.createElement("div");
        nameEl.className = "name";
        nameEl.textContent = `${selected["å•†å“å"]} (${selected["è§„æ ¼"]})`;

        const priceEl = document.createElement("div");
        priceEl.className = "price";
        priceEl.textContent = `Â¥${selected["ä»·æ ¼"]}`;

        const descEl = document.createElement("div");
        descEl.className = "desc";
        descEl.textContent = selected["æè¿°ï¼ˆå¯é€‰ï¼‰"] || '';

        // ä¸‹æ‹‰é€‰æ‹©è§„æ ¼
        const selector = document.createElement("select");
        selector.className = "selector";
        specs.forEach(item => {
          const opt = document.createElement("option");
          opt.value = JSON.stringify(item);
          opt.textContent = `${item["è§„æ ¼"]} â€” Â¥${item["ä»·æ ¼"]}`;
          selector.appendChild(opt);
        });
        selector.addEventListener("change", e => {
          selected = JSON.parse(e.target.value);
          // æ›´æ–°å±•ç¤º
          img.src = selected["å›¾ç‰‡é“¾æŽ¥"];
          nameEl.textContent = `${selected["å•†å“å"]} (${selected["è§„æ ¼"]})`;
          priceEl.textContent = `Â¥${selected["ä»·æ ¼"]}`;
          descEl.textContent = selected["æè¿°ï¼ˆå¯é€‰ï¼‰"] || '';
        });

        const btn = document.createElement("button");
        btn.className = "button";
        btn.textContent = "Add to Cart";
        btn.addEventListener("click", () => {
          cart.push(selected);
          tg.HapticFeedback.notificationOccurred("success");
          tg.MainButton.setText(`ðŸ›’ Checkout (${cart.length})`);
          tg.MainButton.show();
        });

        // æ‹¼è£…å¡ç‰‡
        card.append(img, nameEl, priceEl, descEl, selector, btn);
        container.appendChild(card);
      });
    }

    tg.MainButton.onClick(() => {
      tg.sendData(JSON.stringify(cart));
      tg.close();
    });

    tg.ready();
    loadMenu();
  </script>
</body>
</html>

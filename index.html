<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Green Mart | Multi‚ÄëShop Menu & Delivery</title>
  <link rel="icon" href="/static/favicon.png" type="image/png" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- üî• SEO Meta -->
  <meta name="description" content="Batman1788 - Melbourne Cannabis Menu. Same-day weed delivery, premium strains, vapes, and more. Order via Telegram." />
  <meta name="keywords" content="Batman1788, Melbourne cannabis, weed delivery, marijuana menu, vapes, premium strains, Melbourne weed, Malvern weed" />
  <meta name="author" content="Batman1788" />

  <!-- üî• Open Graph (for link previews) -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Batman1788 | Multi‚ÄëShop Menu & Delivery" />
  <meta property="og:description" content="View our premium cannabis menu. Same-day delivery in Melbourne. Order via Telegram easily." />
  <meta property="og:url" content="https://www.batman1788.shop/" />
  <meta property="og:image" content="https://www.batman1788.shop/static/batman_logo.png" />
  <meta property="og:image:width" content="300" />
  <meta property="og:image:height" content="300" />
  <meta property="og:site_name" content="Batman1788" />

  <!-- üî• Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Batman1788 | Multi‚ÄëShop Menu & Delivery" />
  <meta name="twitter:description" content="Batman1788 - Melbourne cannabis delivery menu. Same-day service, premium strains, vapes & more." />
  <meta name="twitter:image" content="https://www.batman1788.shop/static/batman_logo.png" />

  <!-- Optional: Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5DBPBMP3K1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-5DBPBMP3K1');
  </script>

  <style>
    :root{
      --bat-bg:#0b0c0f; --bat-card:#14151a; --bat-gold:#ffe02e; --bat-fg:#eaeaeb; --muted:#999;
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bat-bg);color:var(--bat-fg);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Noto Sans',Ubuntu,'Helvetica Neue',Arial,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';}
    a{color:var(--bat-gold)}
    .header{padding:16px 14px 0;margin:0;font-size:22px;letter-spacing:.2px;text-align:center}
    .open-hours{color:#c8c8c8;text-align:center;margin:2px 0 10px;font-size:13px}

    /* shop switcher */
    .shopbar{display:flex;gap:10px;align-items:center;padding:10px 12px;overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch}
    .shopbar .sel{background:#0f1014;border:1px solid #262832;border-radius:12px;padding:8px 10px;color:#eee}
    .shopbar .chip{display:inline-flex;flex-direction:column;align-items:center;gap:6px;min-width:66px;padding:8px;border-radius:12px;cursor:pointer;border:1px solid #262832;background:#0f1014;scroll-snap-align:center;white-space:nowrap}
    .shopbar .chip.active{background:var(--bat-gold);color:#111;border-color:var(--bat-gold);font-weight:700;box-shadow:0 0 0 2px rgba(255,224,46,.25)}
    .shop-meta{display:flex;gap:8px;justify-content:center;align-items:center;color:#cfcfcf;font-size:13px;margin:-4px 0 6px}

    .marquee-wrap{overflow:hidden;white-space:nowrap;margin:2px 16px 12px;border:1px dashed #2b2d35;border-radius:10px;color:#d5d5d5}
    .marquee-text{display:inline-block;padding:10px 16px}

    .menu-wrap{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;padding:12px}
    .card{background:var(--bat-card);border-radius:var(--radius);overflow:hidden;border:1px solid #1d1f28}
    .menu-item{display:flex;gap:12px;padding:10px}
    .menu-img{width:110px;height:110px;border-radius:12px;object-fit:cover;flex:none;background:#0f1014;border:1px solid #262832}
    .menu-info{flex:1;min-width:0}
    .menu-name{font-weight:700;margin-bottom:5px;display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .menu-badge{background:#262832;color:#b9b9b9;padding:2px 6px;border-radius:6px;font-size:11px}
    .menu-type{background:#202330;color:#9ad2ff;padding:2px 6px;border-radius:6px;font-size:11px}
    .menu-title{color:#b9b9b9;font-size:13px}
    .menu-desc{color:#bfbfbf;opacity:.92;font-size:13px;margin:2px 0 6px;line-height:1.4}
    .menu-bottom-prices{display:flex;flex-wrap:wrap;gap:8px}
    .menu-spec{background:#111318;border:1px solid #2b2d36;color:#e9e9ea;border-radius:12px;padding:7px 10px;cursor:pointer}

    .cart-bar{position:sticky;bottom:0;left:0;right:0;background:#0c0d12;border-top:1px solid #1f2130;padding:10px 12px;display:flex;align-items:center;justify-content:space-between;z-index:50}
    .cart-info{color:#d8d8d8;font-weight:600}
    .cart-btn{background:var(--bat-gold);border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}

    .checkout-bg{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:1000}
    .checkout-bg.active{display:flex}
    .checkout{width:min(860px,94vw);max-height:90vh;overflow:auto;background:#0d0f13;border:1px solid #1d2130;border-radius:16px;padding:16px}
    .f{display:flex;gap:12px}
    .i{flex:1}
    label{display:block;font-size:13px;color:#c7c7c7;margin:3px 0 6px}
    input,textarea,select{width:100%;background:#0e1016;border:1px solid #2a2d39;color:#f2f2f2;padding:10px 12px;border-radius:12px}
    textarea{resize:vertical}
    .radio-group{display:flex;gap:12px}
    .checkout-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .btn{background:#171923;border:1px solid #2b2f3f;color:#e9e9ea;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:var(--bat-gold);color:#111;border:1px solid var(--bat-gold);font-weight:800}
    .checkout-msg{margin-top:8px;color:#cfcfcf}
    .checkout-msg.err{color:#ff8080}
    .checkout-msg.ok{color:#98ffa8}

    .img-modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:2000}
    .img-modal-bg.active{display:flex}
    .img-modal-bg img{max-width:92vw;max-height:88vh;border-radius:8px}

    .contact-fab{position:fixed;right:14px;bottom:74px;background:var(--bat-gold);border-radius:999px;padding:10px 14px;color:#111;font-weight:800;text-decoration:none;box-shadow:0 6px 18px #0008;z-index:60}
    .contact-fab:hover{transform:translateY(-1px)}

    @media (max-width:600px){
      .menu-wrap{grid-template-columns:repeat(auto-fill,minmax(210px,1fr));}
      .menu-img{width:88px;height:88px}
      .header{font-size:20px}
      .contact-fab{bottom:66px}
    }

    .ad-modal-bg{ position:fixed; inset:0; background:rgba(0,0,0,.78); display:flex; align-items:center; justify-content:center; z-index:10000; }
    .hidden{ display:none!important; }
    .ad-modal{ position:relative; max-width:90vw; max-height:80vh; border-radius:16px; overflow:hidden; box-shadow:0 4px 25px #000a; background:#111; }
    .ad-modal img{ width:100%; height:auto; display:block; }
    .ad-close{ position:absolute; top:6px; right:6px; background:rgba(0,0,0,.6); color:#fff; border:none; border-radius:50%; width:32px; height:32px; font-size:20px; font-weight:bold; cursor:pointer; line-height:30px; }
    .ad-close:hover{ background:rgba(0,0,0,.85); }

    /* phone+addr grid */
    .phone-addr{display:grid;grid-template-columns:.75fr 1.45fr;gap:10px;align-items:end}
    .phone-addr .i{flex:none}
    .phone-addr .i input{width:100%}
    @media (max-width:700px){ .phone-addr{ grid-template-columns:.7fr 1.6fr } }
    @media (max-width:480px){ .phone-addr{ grid-template-columns:.6fr 1.8fr } }
    .pac-container{ z-index:100000 !important; }
      /* === Brand header === */
    .brand{display:flex;flex-direction:column;align-items:center;gap:10px;justify-content:center;padding:14px 14px 0}
    .brand-logo{width:72px;height:72px;border-radius:16px;object-fit:cover;border:1px solid #2a2d36;background:#0f1014;box-shadow:0 4px 20px rgba(0,0,0,.35)}
    .brand-text{display:flex;flex-direction:column;align-items:center}
    .brand-name{font-size:24px;font-weight:900;color:var(--bat-fg);line-height:1.15;text-align:center}
    .brand-sub{font-size:12px;color:#bfbfbf;margin-top:3px}
  .shop-chip-logo{width:36px;height:36px;border-radius:10px;object-fit:cover;border:1px solid #2a2d36;background:#0e0f14}
    .shop-chip-name{font-size:11px;color:#cfcfcf;max-width:78px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .shopbar .chip.active .shop-chip-name{color:#111}
  .shopbar .sel{display:none !important}
  </style>
</head>
<body>
  <div class="brand">
    <img id="brandLogo" class="brand-logo" src="/static/batman_logo.png" alt="Shop Logo"/>
    <div class="brand-text">
      <div id="brandName" class="brand-name">Batman1788</div>
      <div class="brand-sub">Multi‚ÄëShop Menu & Delivery</div>
    </div>
  </div>
  <div class="open-hours">OPEN Daily 10:00AM - 10:00PM</div>

  <!-- Shop switcher -->
  <div class="shopbar" id="shopBar">
    <select id="shopSelect" class="sel" aria-label="Shop selector"></select>
    <div id="shopChips" style="display:flex;gap:8px;flex-wrap:nowrap"></div>
  </div>
  <div class="shop-meta">
    <span id="shopPickup"></span>
    <span id="shopTelegram"></span>
  </div>

  <!-- Notice marquee -->
  <div class="marquee-wrap">
    <div id="marqueeInner" style="white-space:nowrap;display:flex;">
      <span class="marquee-text" id="marqueeText"></span>
      <span class="marquee-text" id="marqueeTextClone"></span>
    </div>
  </div>

  <!-- Bind Telegram -->
  <div style="max-width:530px;margin:10px auto 0; padding:0 12px; text-align:center;">
    <button type="button" class="menu-spec" onclick="bindTelegram()">One‚Äëclick binding Telegram</button>
  </div>

  <div class="menu-wrap" id="menu"></div>

  <!-- Cart bar -->
  <div class="cart-bar">
    <div class="cart-info" id="cartInfo">Shopping Cart 0 Item ¬∑ $0.00</div>
    <button class="cart-btn" id="checkoutBtn" onclick="openCheckout()" disabled>Check Out</button>
  </div>

  <!-- Checkout modal -->
  <div class="checkout-bg" id="checkoutBg">
    <div class="checkout">
      <h3>Fill in the information</h3>

      <div class="f"><div class="i">
        <label>Shop</label>
        <input id="custShop" disabled />
      </div></div>

      <div class="f"><div class="i">
        <label>Name</label><input id="custName" placeholder="Recipient's name" />
      </div></div>

      <!-- Delivery method -->
      <div class="f"><div class="i">
        <label>Delivery method</label>
        <div class="radio-group">
          <label><input type="radio" name="ship" value="delivery" checked> Delivery</label>
          <label><input type="radio" name="ship" value="pickup"> Pickup</label>
        </div>
      </div></div>

      <div class="f phone-addr">
        <div class="i"><label>Phone No.</label><input id="custPhone" placeholder="+61 ." /></div>
        <div class="i"><label>Address</label><input id="custAddr" placeholder="Full address" /></div>
      </div>

      <div class="f"><div class="i">
        <label>Notes (optional)</label><textarea id="custNotes" rows="3" placeholder="Example: Gender, Race / Clothing-color"></textarea>
      </div></div>

      <!-- Delivery time -->
      <div class="f"><div class="i">
        <label>Delivery time</label>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label><input type="radio" name="dtime" value="asap" checked> ASAP</label>
          <label><input type="radio" name="dtime" value="scheduled"> Choose time</label>
          <input id="timePicker" type="datetime-local" style="display:none" />
        </div>
      </div></div>

      <!-- PROMO ËæìÂÖ•Âå∫ -->
      <div class="f"><div class="i">
        <label>Promo Code</label>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="promoCodeInput" placeholder="Enter promo code" />
          <button class="btn" type="button" onclick="applyPromoCode()">Apply</button>
          <button class="btn" type="button" onclick="clearPromoCode()">Clear</button>
        </div>
        <div id="promoMsg" class="checkout-msg"></div>
      </div></div>

      <div id="orderSummary" class="order-summary"></div>

      <div class="checkout-actions">
        <button class="btn" onclick="closeCheckout()">Cancel</button>
        <button class="btn primary" onclick="submitOrder()">Submit Order</button>
      </div>
      <div class="checkout-msg" id="checkoutMsg"></div>
    </div>
  </div>

  <!-- Floating contact -->
  <a href="https://t.me/batman1788" target="_blank" class="contact-fab" title="Customer Service" aria-label="Customer Service on Telegram">
    Customer
  </a>

  <!-- Image modal -->
  <div class="img-modal-bg" id="imgModal" onclick="this.classList.remove('active')">
    <img id="imgModalPic" src="" alt="Preview" />
  </div>

  <!-- Ad modal -->
  <div class="ad-modal-bg hidden" id="adModal" aria-hidden="true">
    <div class="ad-modal">
      <img id="adImg" src="" alt="Promo" />
      <button class="ad-close" type="button" onclick="window.closeAd()" aria-label="Close">√ó</button>
    </div>
  </div>

  <script>
    // ======= Config =======
    const API_BASE = ""; // same origin
    const SHEET_ID = "1hUlRnvEy-k2Arz8SVKpRsAaBEFTyS6RDJBDfwDmM-Hs"; // <- ‰Ω†ÁöÑ Google Sheet
    const TABS = {
      menu:   'batmenu',   // ÈªòËÆ§ËèúÂçïË°®
      notice: 'notice',
      ad:     'ad',
      shops:  'shops'      // ‚ú® Êñ∞Â¢ûÔºöÂ§öÂ∫óÈÖçÁΩÆË°®ÔºàËßÅ‰∏ãÊñπÂàóÂÆö‰πâÔºâ
    };

    // shops Ë°®ÂàóÔºöenabled | id | name | tab | promo_tab | pickup_address | tg | sort
    const BASE_OS = (tab) => `https://opensheet.elk.sh/${SHEET_ID}/${tab}`;
    const URL = {
      shops:  BASE_OS(TABS.shops),
      promo:  (tab) => BASE_OS(tab || 'promo'),
      menu:   (tab) => BASE_OS(tab || TABS.menu),
      notice: BASE_OS(TABS.notice),
      ad:     BASE_OS(TABS.ad)
    };

    // ======= Utils & State =======
    const cart = [];
    const CURRENCY = "$";
    function money(n){ const v = Number(n)||0; return CURRENCY + new Intl.NumberFormat('en-US',{maximumFractionDigits:0,minimumFractionDigits:0}).format(v); }
    function normPrice(val){ const n = Number(String(val??'').replace(/[^\d.-]/g,'')); return Number.isFinite(n)? n : 0; }
    function showImgModal(src){ document.getElementById('imgModalPic').src = src; document.getElementById('imgModal').classList.add('active'); }
    function isTrue(v){ return /^(?:y|yes|true|1|sold(?:\s*out)?|ÂîÆÁΩÑ|Áº∫Ë¥ß)$/i.test(String(v||'').trim()); }
    function isYes(v){ return /^(?:y|yes|true|1)$/i.test(String(v||'').trim()); }
    function stripCodeMark(name){ return String(name||'').replace(/\s*[\(\[Ôºà„Äê]\s*[A-Za-z0-9\u4e00-\u9fff]{1,8}\s*[\)\]Ôºâ„Äë]\s*$/, ''); }

    // Melbourne ÂΩìÂ§©
    function ymdMel(){ const d = new Date(new Date().toLocaleString("en-US",{timeZone:"Australia/Melbourne"})); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}-${mm}-${dd}`; }
    function isActiveNow(p){ if(!p.start && !p.end) return true; const today = ymdMel(); const s = p.start || '0000-01-01'; const e = p.end || '9999-12-31'; return s<=today && today<=e; }

    // ======= Shop state =======
    let SHOPS = [];              // [{id,name,tab,promo_tab,pickup_address,tg,sort}]
    let CUR = null;              // ÂΩìÂâç shop ÂØπË±°
    let PROMO_RULES = [];        // ÂΩìÂâçÂ∫óÈì∫ÂèØÁî®ÁöÑÊ¥ªÂä®
    let MANUAL_PROMO = null;     // ÊâãËæì codeÔºàÂè†Âä†Âà§Êñ≠ËßÅ calcPromoÔºâ

    function normalizeShop(r){
      return {
        enabled: isYes(r.enabled),
        id: String(r.id||r.shop||'default').trim(),
        name: (function(){
  const n = String(r.name||r.shop_name||r.title||'').trim();
  if (n) return n;
  const idf = String(r.id||r.shop||'Shop');
  return idf.replace(/[_-]+/g,' ').replace(/\b\w/g, s=>s.toUpperCase());
})(),
        tab: String(r.tab||r.menu_tab||TABS.menu).trim(),
        promo_tab: String(r.promo_tab||'promo').trim(),
        pickup_address: String(r.pickup_address||'1 Kingston St, Malvern East VIC 3145, Australia').trim(),
        tg: String(r.tg||r.telegram||'https://t.me/batman1788').trim(),
        sort: Number(r.sort||0) || 0,
        logo: String(r.logo||r.logo_url||'').trim()
      };
    }

    async function loadShops(){
      try{
        const rows = await fetch(`${URL.shops}?t=${Date.now()}`, {cache:'no-store'}).then(r=>r.json());
        SHOPS = (rows||[]).map(normalizeShop).filter(s=>s.enabled).sort((a,b)=>a.sort-b.sort || a.name.localeCompare(b.name));
      }catch(e){ SHOPS = []; }
      if(!SHOPS.length){ SHOPS = [normalizeShop({enabled:'yes',id:'main',name:'Batman1788',tab:TABS.menu})]; }
      const saved = localStorage.getItem('shop_id');
      const pick = SHOPS.find(s=>s.id===saved) || SHOPS[0];
      setShop(pick.id);
      renderShopSwitcher();
    }

    function renderShopSwitcher(){
      const sel = document.getElementById('shopSelect');
      sel.innerHTML = SHOPS.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
      sel.value = CUR?.id || SHOPS[0].id;
      sel.onchange = (e)=> setShop(e.target.value);

      const chips = document.getElementById('shopChips');
      chips.innerHTML = SHOPS.map(s=>`<button class="chip ${s.id===CUR.id?'active':''}" onclick="setShop('${s.id}')" aria-pressed="${s.id===CUR.id}" title="${s.name}"><img class="shop-chip-logo" src="${s.logo || '/static/batman_logo.png'}" alt="${s.name} logo"/><span class="shop-chip-name">${s.name}</span></button>`).join('');

      // meta line
      document.getElementById('shopPickup').textContent = `Pickup: ${CUR.pickup_address || '-'}`;
      const tgA = CUR.tg ? `<a href="${CUR.tg}" target="_blank" rel="noopener">Telegram</a>` : '';
      document.getElementById('shopTelegram').innerHTML = tgA;
      document.getElementById('custShop').value = `${CUR.name}`;

      // === brand header ===
      const logoEl = document.getElementById('brandLogo');
      const nameEl = document.getElementById('brandName');
      if (logoEl) { logoEl.src = CUR.logo || '/static/batman_logo.png'; }
      if (nameEl) { nameEl.textContent = CUR.name || 'Shop'; }
    }

    async function setShop(id){
      const s = SHOPS.find(x=>x.id===id) || SHOPS[0];
      CUR = s; localStorage.setItem('shop_id', s.id);
      // Êõ¥Êñ∞ pickup Âú∞ÂùÄÈªòËÆ§
      PICKUP_ADDRESS = CUR.pickup_address || PICKUP_ADDRESS;
      // ÈáçÊñ∞Âä†ËΩΩ‰øÉÈîÄ‰∏éËèúÂçï
      await Promise.all([loadPromos(), loadMenu()]);
      renderShopSwitcher();
    }

    // ======= PROMO rulesÔºàÂàÜÂ∫óÂä†ËΩΩÔºâ =======
    function normalizePromoRow(r){
      return {
        enabled: isYes(r.enabled),
        type: String(r.type||'').trim().toLowerCase(),   // freeship | minus | percent | info | gift | bundle
        value: Number(r.value || 0) || 0,
        min: Number(r.min_subtotal || r.min || 0) || 0,
        code: String(r.code||'').trim().toUpperCase(),
        auto: isYes(r.auto),
        stack: isYes(r.stack) || String(r.stack||'').trim().toLowerCase() !== 'no',
        desc: String(r.desc||r.note||'').trim(),
        start: String(r.start||'').trim(),
        end:   String(r.end||'').trim()
      };
    }

    async function loadPromos(){
      try{
        const url = URL.promo(CUR?.promo_tab);
        const rows = await fetch(`${url}?t=${Date.now()}`, {cache:'no-store'}).then(r=>r.json());
        PROMO_RULES = (rows||[]).map(normalizePromoRow).filter(p=>p.enabled && isActiveNow(p));
      }catch(e){ PROMO_RULES = []; }
      MANUAL_PROMO = null; // ÂàáÂ∫óÂêéÊ∏ÖÁ©∫ÊâãËæì
    }

    // ======= Notice marquee =======
    (function(){
      fetch(URL.notice).then(r=>r.json()).then(rows=>{
        let notices = rows.map(r=>r.msg).filter(Boolean);
        let mainMsg = notices[0] || "";
        let others = notices.slice(1);
        let now = new Date();
        let mel = new Date(now.toLocaleString("en-US",{timeZone:"Australia/Melbourne"}));
        if(mel.getHours() < 10) mel.setDate(mel.getDate()-1);
        let idx = (mel.getFullYear()*372 + (mel.getMonth()+1)*31 + mel.getDate());
        let oneMsg = others.length? others[idx % others.length] : "";
        const showText = oneMsg? (mainMsg + "   |   " + oneMsg) : mainMsg;
        const marquee = document.getElementById('marqueeText');
        const clone = document.getElementById('marqueeTextClone');
        marquee.innerText = showText; clone.innerText = showText;
        const inner = document.getElementById('marqueeInner'); let speed = 1.2; let pos = 0;
        function scroll(){ const unitWidth = marquee.offsetWidth; pos -= speed; if(Math.abs(pos)>=unitWidth) pos = 0; inner.style.transform=`translateX(${pos}px)`; requestAnimationFrame(scroll); }
        setTimeout(scroll, 350);
      });
    })();

    // ======= Ad modal =======
    window.closeAd = function(){ const m = document.getElementById('adModal'); if(m) m.classList.add('hidden'); };
    (function(){
      fetch(URL.ad).then(r=>r.json()).then(rows=>{
        if(rows && rows.length){
          const r = rows[0]||{}; const enabled = String(r.enabled||'').trim().toLowerCase()==='yes';
          const adImg = (r.img||'').trim();
          if(enabled && adImg){ const m = document.getElementById('adModal'); const img = document.getElementById('adImg'); img.src = adImg; m.classList.remove('hidden'); }
        }
      });
    })();

    // ======= MenuÔºàÊåâÂ∫óÂä†ËΩΩ + Ë°åËßÑËåÉÂåñ + ËøáÊª§Ôºâ =======
    let PICKUP_ADDRESS = "1 Kingston St, Malvern East VIC 3145, Australia"; // ‰ºöË¢´Â∫óÈì∫Ë¶ÜÁõñ

    function normalizeMenuRow(r){
      const priceQ = normPrice(r.q||r.Q||r.price_q);
      const priceH = normPrice(r.h||r.H||r.price_h);
      const priceOZ = normPrice(r.oz||r.OZ||r.price_oz);
      return {
        name: String(r.name||'').trim(),
        badge: String(r.badge||'').trim(),
        type: String(r.type||'').trim(),
        title: String(r.title||'').trim(),
        desc: String(r.desc||'').trim(),
        img: String(r.img||'').trim(),
        thccbd: String(r.thccbd||'').trim(),
        shop: String(r.shop||r.shop_id||'').trim(),  // ‚ú® Êñ∞ÂàóÔºàÂèØÈÄâÔºâÔºöÊâÄÂ±ûÂ∫ó
        priceQ, priceH, priceOZ
      };
    }

    async function loadMenu(){
      const tab = CUR?.tab || TABS.menu;
      const url = URL.menu(tab);
      const rows = await fetch(`${url}?t=${Date.now()}`, {cache:'no-store'}).then(r=>r.json()).catch(()=>[]);
      const items = (rows||[]).map(normalizeMenuRow)
        .filter(it=> it.name)
        .filter(it=> !it.shop || it.shop.toLowerCase()===(CUR.id||'').toLowerCase()); // Êúâ shop ÂàóÊó∂‰∏•Ê†ºÂåπÈÖçÔºõÊó†ÂàôÈªòËÆ§ÊâÄÊúâÂ∫óÂèØËßÅ

      // Ê∏≤Êüì
      const html = items.map(obj=>{
        const dispNameTitle = stripCodeMark(obj.name);
        const thccbd = obj.thccbd? String(obj.thccbd).replace(/\s+/g,'') : '';
        const btns = [
          obj.priceQ>0? `<button class="menu-spec" onclick="addToCart('${obj.name.replace(/'/g,"\\'")}', 'Q', ${obj.priceQ}, '${obj.img.replace(/'/g,"\\'")}', '${dispNameTitle.replace(/'/g,"\\'")}')">Q ${money(obj.priceQ)}</button>`:'' ,
          obj.priceH>0? `<button class="menu-spec" onclick="addToCart('${obj.name.replace(/'/g,"\\'")}', 'H', ${obj.priceH}, '${obj.img.replace(/'/g,"\\'")}', '${dispNameTitle.replace(/'/g,"\\'")}')">H ${money(obj.priceH)}</button>`:'' ,
          obj.priceOZ>0? `<button class="menu-spec" onclick="addToCart('${obj.name.replace(/'/g,"\\'")}', 'OZ', ${obj.priceOZ}, '${obj.img.replace(/'/g,"\\'")}', '${dispNameTitle.replace(/'/g,"\\'")}')">OZ ${money(obj.priceOZ)}</button>`:''
        ].filter(Boolean).join('');

        return `
          <div class="card menu-item">
            ${obj.img? `<img class="menu-img" src="${obj.img}" loading="lazy" onclick="showImgModal('${obj.img}')" alt="item"/>` : ""}
            <div class="menu-info">
              <div class="menu-name">
                ${dispNameTitle || ""}
                ${obj.badge ? `<span class="menu-badge">${obj.badge}</span>` : ""}
                ${obj.type ? `<span class="menu-type">${obj.type}</span>` : ""}
              </div>
              <div style="display:flex;align-items:center;gap:9px;margin-bottom:2px;flex-wrap:wrap;">
                ${obj.title ? `<span class="menu-title">${obj.title}</span>` : ""}
                ${thccbd ? `<span class="menu-thccbd">THC/CBD: ${thccbd}</span>` : ""}
              </div>
              ${obj.desc ? `<div class="menu-desc">${obj.desc}</div>` : ""}
              <div class="menu-bottom-prices">${btns || '<span style="color:#ccc">No price</span>'}</div>
            </div>
          </div>
        `;
      }).join('');
      document.getElementById('menu').innerHTML = html || `<div style="text-align:center;color:#ccc;margin-top:40px;">No items</div>`;
    }

    // ======= Cart / checkout =======
    function addToCart(name, spec, price, img, disp){
      const hit = cart.find(x => x.name === name && x.spec === spec);
      if (hit) hit.qty += 1; else cart.push({ name, disp: disp || stripCodeMark(name), spec, price, qty: 1, img });
      renderCartBar(); if (document.getElementById('checkoutBg').classList.contains('active')) renderOrderSummary();
    }
    function renderCartBar(){ const cnt = cart.reduce((a,b)=>a+b.qty,0); const total = cart.reduce((a,b)=>a+b.qty*b.price,0); document.getElementById('cartInfo').textContent = `Shopping Cart ${cnt} Item ¬∑ ${money(total)}`; document.getElementById('checkoutBtn').disabled = (cnt === 0); }
    function removeItem(idx){ if (idx < 0 || idx >= cart.length) return; cart.splice(idx, 1); renderCartBar(); renderOrderSummary(); if (cart.length === 0) closeCheckout(); }
    window.removeItem = removeItem;

    // ======= Promo engine =======
    function getApplicablePromos(subtotal){ const autos = PROMO_RULES.filter(p => p.auto && subtotal >= p.min); const manualOk = (MANUAL_PROMO && subtotal >= MANUAL_PROMO.min) ? [MANUAL_PROMO] : []; return [...autos, ...manualOk]; }
    function applyPromoCode(){ const inp = document.getElementById('promoCodeInput'); const code = (inp.value||'').trim().toUpperCase(); const msg = document.getElementById('promoMsg'); if(!code){ MANUAL_PROMO=null; msg.textContent=''; renderOrderSummary(); return; } const p = PROMO_RULES.find(x=>x.code===code); if(!p){ msg.textContent='Invalid code'; MANUAL_PROMO=null; renderOrderSummary(); return; } MANUAL_PROMO = p; msg.textContent = p.desc || 'Promo applied'; renderOrderSummary(); }
    function clearPromoCode(){ MANUAL_PROMO=null; document.getElementById('promoCodeInput').value=''; document.getElementById('promoMsg').textContent=''; renderOrderSummary(); }

    function computeBundleDiscount(cart, target){
      // ‰∏éÂêéÁ´Ø‰∏ÄËá¥ÔºöQ=1,H=2,OZ=4 ÁöÑÁ∫øÊÄßÊäòÊâ£ÔºàÁ§∫ÊÑèÁâàÔºâ
      const MULT = {Q:1,H:2,OZ:4};
      const units = [];
      cart.forEach(it=>{ const specUp = String(it.spec||'').toUpperCase(); const m = MULT[specUp] || 0; if(m>0){ for(let i=0;i<m*it.qty;i++) units.push({price:it.price}); } });
      units.sort((a,b)=>b.price-a.price);
      let cnt=0, disc=0; for(const u of units){ cnt++; if(cnt%2===0){ disc += (Number(target)||0); } }
      return disc; // ÁÆÄÂåñÔºöÊØè‚ÄúÁ¨¨‰∫åÂçï‰Ωç‚ÄùÂáèÂéª target
    }

    function calcPromo(subtotal, baseShipping){
      let discount = 0; let promos=[]; let freeShip=false;
      for(const p of PROMO_RULES){ if(subtotal>=p.min){ if(p.type==='percent'){ discount += Math.round(subtotal * (p.value/100)); promos.push(p); } else if(p.type==='minus'){ discount += Math.round(p.value); promos.push(p); } else if(p.type==='freeship'){ freeShip = true; promos.push(p); } else if(p.type==='bundle' && p.value>0){ const d = computeBundleDiscount(cart, Number(p.value)||0); if(d>0){ discount += d; promos.push(p); } } } }
      if(MANUAL_PROMO && subtotal>=MANUAL_PROMO.min){ if(!promos.find(x=>x.code===MANUAL_PROMO.code)){ promos.push(MANUAL_PROMO); if(MANUAL_PROMO.type==='percent'){ discount += Math.round(subtotal * (MANUAL_PROMO.value/100)); } else if(MANUAL_PROMO.type==='minus'){ discount += Math.round(MANUAL_PROMO.value); } else if(MANUAL_PROMO.type==='freeship'){ freeShip=true; } else if(MANUAL_PROMO.type==='bundle' && MANUAL_PROMO.value>0){ discount += computeBundleDiscount(cart, Number(MANUAL_PROMO.value)||0); } } }
      const shipping = freeShip? 0 : baseShipping; const grand = Math.max(0, subtotal - discount + shipping);
      return {discount, shipping, grand, promos};
    }

    // ======= Delivery method =======
    function getShipMethod(){ return document.querySelector('input[name="ship"]:checked')?.value || 'delivery'; }
    function onShipChange(){ const method = getShipMethod(); const addrInput = document.getElementById('custAddr'); if(method==='pickup'){ addrInput.value = PICKUP_ADDRESS; addrInput.disabled = true; } else { if(addrInput.value===PICKUP_ADDRESS) addrInput.value=''; addrInput.disabled=false; addrInput.placeholder='Full address'; } renderOrderSummary(); }
    document.addEventListener('change', (e)=>{ if(e.target && e.target.name==='ship') onShipChange(); });

    // ======= Delivery time pickers =======
    function getDeliveryTimePayload(){
      const mode = document.querySelector('input[name="dtime"]:checked')?.value || 'asap';
      if(mode==='asap') return {delivery_mode:'asap', delivery_time:null};
      const v = document.getElementById('timePicker').value;
      if(!v) throw new Error('need time');
      const mel = new Date(new Date(v).toLocaleString('en-US',{timeZone:'Australia/Melbourne'}));
      const iso = new Date(mel.getTime() - mel.getTimezoneOffset()*60000).toISOString();
      return {delivery_mode:'scheduled', delivery_time: iso};
    }
    document.addEventListener('change', (e)=>{
      if(e.target && e.target.name==='dtime'){
        const scheduled = (e.target.value==='scheduled');
        document.getElementById('timePicker').style.display = scheduled? 'inline-block':'none';
      }
    });

    // ======= Checkout =======
    function openCheckout(){ document.getElementById('checkoutBg').classList.add('active'); renderOrderSummary(); }
    function closeCheckout(){ document.getElementById('checkoutBg').classList.remove('active'); }

    function renderOrderSummary(){
      const ship = getShipMethod();
      const subtotal = cart.reduce((a,b)=> a + b.qty*b.price, 0);
      const baseShipping = ship==='delivery'? 20 : 0;
      const promoCalc = calcPromo(subtotal, baseShipping);
      const lines = [
        `<div style="font-weight:700;margin-bottom:6px">${CUR?.name || 'Shop'}</div>`,
        ...cart.map((it,i)=>`<div style="display:flex;gap:10px;align-items:center;margin:8px 0">
          ${it.img? `<img src="${it.img}" style="width:48px;height:48px;border-radius:10px;object-fit:cover;border:1px solid #282a36">` : ''}
          <div style="flex:1">
            <div style="font-weight:700">${stripCodeMark(it.disp||it.name)} <span style="opacity:.7">${it.spec}</span></div>
            <div style="color:#c7c7c7">${money(it.price)} √ó ${it.qty}</div>
          </div>
          <button class="menu-spec" onclick="removeItem(${i})">Remove</button>
        </div>`),
        `<div style="border-top:1px dashed #2a2d37;margin:8px 0"></div>`,
        `<div>Subtotal: <b>${money(subtotal)}</b></div>`,
        (promoCalc.discount>0? `<div>Discount: <b>-${money(promoCalc.discount)}</b></div>`:''),
        `<div>Shipping: <b>${money(promoCalc.shipping)}</b></div>`,
        `<div style="font-size:18px;margin-top:2px">Total: <b>${money(promoCalc.grand)}</b></div>`
      ];
      document.getElementById('orderSummary').innerHTML = lines.join('');
    }

    async function submitOrder(){
      const msg = document.getElementById('checkoutMsg');
      const submitBtn = document.querySelector('.btn.primary');
      submitBtn.disabled = true; submitBtn.textContent = 'Submitting...';

      const name  = document.getElementById('custName').value.trim();
      const phone = document.getElementById('custPhone').value.trim();
      const addr  = document.getElementById('custAddr').value.trim();
      const notes = document.getElementById('custNotes').value.trim();
      const ship  = getShipMethod();

      msg.className='checkout-msg'; msg.textContent='';
      if(!cart.length){ msg.className='checkout-msg err'; msg.textContent='Cart is empty'; submitBtn.disabled=false; submitBtn.textContent='Submit Order'; return; }
      if(!name || !phone || !addr){ msg.className='checkout-msg err'; msg.textContent='Please fill in your name / phone number / address'; submitBtn.disabled=false; submitBtn.textContent='Submit Order'; return; }
      if(cart.some(x => !x.price || x.price <= 0)){ msg.className='checkout-msg err'; msg.textContent='Some product prices are invalid, please refresh and try again'; submitBtn.disabled=false; submitBtn.textContent='Submit Order'; return; }

      let timePayload; try{ timePayload = getDeliveryTimePayload(); }catch(e){ msg.className='checkout-msg err'; msg.textContent='Please choose a delivery time'; submitBtn.disabled=false; submitBtn.textContent='Submit Order'; return; }

      const subtotal = cart.reduce((a,b)=> a + b.qty*b.price, 0);
      const baseShipping = ship==='delivery'? 20 : 0;
      const promoCalc = calcPromo(subtotal, baseShipping);

      const payload = {
        shop_id: CUR?.id || 'main',                 // ‚ú® Êñ∞Â¢ûÔºöÂ∫óÈì∫ id
        shop_name: CUR?.name || 'Main Shop',        // ‚ú® Êñ∞Â¢ûÔºöÂ∫óÈì∫Âêç
        items: cart.map(x=>({name:x.name,spec:x.spec,price:x.price,qty:x.qty})),
        name, phone, address: addr, notes,
        delivery: ship,
        checkout: {
          subtotal,
          discount: Math.round(promoCalc.discount),
          shipping_fee: Math.round(promoCalc.shipping),
          total: Math.round(promoCalc.grand),
          promo_applied: promoCalc.promos.map(p=>({code:p.code||'',type:p.type,value:p.value,min:p.min,desc:p.desc,start:p.start||'',end:p.end||''}))
        },
        delivery_mode: timePayload.delivery_mode,
        delivery_time: timePayload.delivery_time
      };

      const tgChatId = localStorage.getItem('tg_chat_id');
      if (!tgChatId){ msg.className='checkout-msg err'; msg.innerHTML='Please bind Telegram before placing an order <a href="#" onclick="bindTelegram();return false;">Bind Now</a>'; submitBtn.disabled=false; submitBtn.textContent='Submit Order'; return; }
      payload.tg_chat_id = tgChatId;

      try{
        const res = await fetch(`${API_BASE}/order`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
        const data = await res.json();
        if(res.ok){
          msg.className='checkout-msg ok';
          if (data.user_notified){ msg.textContent = 'Order successful! You have been notified via Telegram.'; }
          else if (data.tg_deeplink){ msg.innerHTML = 'Order placed! Click here to receive this order in Telegram üëâ ' + `<a href="${data.tg_deeplink}" target="_blank" rel="noopener">Enable notifications</a>`; }
          else { msg.textContent = 'Order SuccessfullyÔºÅ'; }
          cart.splice(0, cart.length); renderCartBar();
          document.getElementById('custName').value = document.getElementById('custPhone').value = document.getElementById('custAddr').value = document.getElementById('custNotes').value = '';
          document.getElementById('promoCodeInput').value = ''; MANUAL_PROMO = null; setTimeout(closeCheckout, 1200);
        } else {
          msg.className='checkout-msg err'; msg.textContent = data.error || 'Failed, please try again later';
        }
      }catch(e){ msg.className='checkout-msg err'; msg.textContent='Network Error, please try again later'; }
      finally{ submitBtn.disabled=false; submitBtn.textContent='Submit Order'; }
    }

    // ======= Bind TelegramÔºàÊ≤øÁî®‰Ω†ÂêéÁ´Ø /bind/create ÊµÅÁ®ãÔºâ =======
    async function bindTelegram(){
      try{
        const r = await fetch('/bind/create');
        const j = await r.json();
        if(!j.code){ alert('Bind failed'); return; }
        localStorage.setItem('bind_code', j.code);
        if(j.tg_deeplink){ window.open(j.tg_deeplink, '_blank'); }
        // ËΩÆËØ¢Á°ÆËÆ§
        const t0 = Date.now();
        const timer = setInterval(async()=>{
          const rs = await fetch(`/bind/status?code=${encodeURIComponent(j.code)}`); const js = await rs.json();
          if(js.status==='ok'){ clearInterval(timer); localStorage.setItem('tg_chat_id', js.chat_id); alert('Bind success'); }
          else if(Date.now()-t0 > 120000){ clearInterval(timer); alert('Bind timeout'); }
        }, 2000);
      }catch(e){ alert('Bind error'); }
    }

    // ======= Boot =======
    loadShops();
    onShipChange();
  </script>
</body>
</html>
